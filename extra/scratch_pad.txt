# scrape-related specs in right_site
bundle exec spec --color -f nested spec/daemon/metadata_scrape_daemon_spec.rb
bundle exec spec --color -f nested spec/lib/metadata_scrape_worker_spec.rb
bundle exec spec --color -f nested spec/lib/right_executable/metadata_scraper_spec.rb
bundle exec spec --color -f nested spec/lib/right_executable/scanners/cookbook_filename_scanner_spec.rb
bundle exec spec --color -f nested spec/models/cookbook_repo_spec.rb


# legacy chef gem versions
root@daemons403-1:/tmp/warden# ls /tmp/warden/rootfs/var/lib/gems/1.9.1/gems/
chef-11.4.4      ipaddress-0.8.0  mixlib-authentication-1.3.0  mixlib-log-1.6.0       net-ssh-gateway-1.2.0  rest-client-1.6.7
erubis-2.7.0     json-1.7.7       mixlib-cli-1.3.0             mixlib-shellout-1.1.0  net-ssh-multi-1.1      systemu-2.5.2
highline-1.6.19  mime-types-1.23  mixlib-config-1.1.2          net-ssh-2.6.7          ohai-6.16.0            yajl-ruby-1.1.0


# right_site model
cookbook_repo = CookbookRepo.find(241487003)
File.open(::File.join(::ENV['HOME'], 'src/right_scraper/tmp/repository.json'), 'w') { |f| f.write(JSON.pretty_generate(cookbook_repo.to_hash)) }


SCRAPE_DIR = '/tmp/metadata_scrape_worker'
SCRAPE_MAX_SIZE = 10 * 1024**3
SCRAPE_MAX_TIME = 600

options = {
  :kind        => :cookbook,        
  :basedir     => SCRAPE_DIR,        
  :max_bytes   => SCRAPE_MAX_SIZE,        
  :max_seconds => SCRAPE_MAX_TIME,        
  :s3_key      => ENV['AWS_ACCESS_KEY_ID'],        
  :s3_secret   => ENV['AWS_SECRET_ACCESS_KEY'],        
  :s3_bucket   => ENV['S3_BUCKET'],        
  :builders    => ['RightScraper::Builders::Filesystem'],
  :scanners    => [
    'RightScraper::Scanners::CookbookMetadata',
    'RightScraper::Scanners::CookbookManifest',
    'RightScraper::Scanners::CookbookS3Upload',
    'RightScraper::Scanners::CookbookFilenameScanner'
  ]
}

File.open(::File.join(::ENV['HOME'], 'src/right_scraper/tmp/options.json'), 'w') { |f| f.write(JSON.pretty_generate(options.to_hash)) }


# retrieve
bundle exec ruby bin/right_scraper-retrieve tmp/options.json tmp/repository.json > tmp/retrieved.json

# scan
bundle exec ruby bin/right_scraper-scan tmp/options.json tmp/retrieved.json
